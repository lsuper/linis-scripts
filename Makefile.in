SCRIPTS="$$HOME/lab/linis/scripts"
TMT=java -jar $$HOME/local/tmt-0.4.0.jar

.PRECIOUS: clean.txt

all: lemmatized.csv

lda-default: lda100/document-topic-distributions.csv

source.txt: txt
	$(SCRIPTS)/txtdir2csv.sh $< $@

clean.txt: source.txt
	$(SCRIPTS)/clean.sed $< > $@

lemmatized.txt: clean.txt
	mystem -lcf -e utf-8 $< | $(SCRIPTS)/demystem.py > $@

lemmatized.csv: lemmatized.txt
	sed -e 's/[^-[:alnum:][:space:]]//g' -e 's/^............/&,/' $< > $@

check: lemmatized.csv
	awk -F, 'BEGIN{p=0} {if (!($$1==p+1)) {print p}; p=$$1; next} ' $<

term-pos.txt: term-index.txt
	mystem -e utf-8 -lic $< | sed 's/^{[^=}]\+[=?]\([^=,]*\)[^}]*}/\1/' > $@

lda%/document-topic-distributions.csv: config%.scala lemmatized.csv 
	time $(TMT) $<

dist-lda:
	zip -r lda-$(shell basename `realpath .`).zip lda*/{description.txt,document-topic-distributions.csv} \
	$(shell  for i in lda* ; do find $$i -type d  | sort | tail -1 ; done)/*
